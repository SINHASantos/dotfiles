#!/bin/sh

check_for_zsh() {
  if !(echo $SHELL | grep zsh > /dev/null)
  then
    echo "Switch to using zsh before continuing"
    exit 1
  fi

  echo "zsh ✓"
}

clone_dotfiles() {
  if [[ ! -d ~/dotfiles ]]
  then
    git clone https://github.com/davidpdrsn/dotfiles.git ~/dotfiles
  else
    cd ~/dotfiles
    git pull > /dev/null
  fi

  echo "dotfiles repo ✓"
}

setup_symlinks() {
  for source in `find ~/dotfiles -iname "*.symlink"`
  do
    dest="$HOME/.`basename \"${source%.*}\"`"
    rm -rf $dest
    ln -s $source $dest
  done

  echo "symlinks ✓"
}

setup_vim() {
  if [[ ! -d ~/.vim/autoload/plug.vim ]]; then
    curl -fLo ~/.vim/autoload/plug.vim --create-dirs https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
    vim +PlugInstall +qall
  fi

  mkdir -p ~/.vim/tmp
  mkdir -p ~/.vim/tmp/backup
  mkdir -p ~/.vim/tmp/undo

  echo "vim ✓"
}

setup_tmux() {
  if [[ ! -d ~/.tmux/plugins/tpm ]]; then
    git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
  fi

  echo "tmux ✓"
}

check_for_homebrew() {
  if [ $(uname) = "Darwin" ]; then
    if !(which brew > /dev/null)
    then
      ruby -e "$(curl -fsSL https://raw.github.com/Homebrew/homebrew/go/install)"
      echo "You should consider running '~/dotfiles/script/install-brews' to install awesome brews."
    fi

    if brew doctor &> /dev/null
    then
      echo "homebrew ✓"
    else
      echo "homebrew not configured correctly. Run 'brew doctor' and see whats up."
      exit 1
    fi
  fi
}

install_gems() {
  cat gems | xargs gem install

  echo "gems ✓"
}

make_local_configs() {
  touch ~/.vimrc.local
  touch ~/.tmux.conf.local
}

check_for_zsh
clone_dotfiles
setup_symlinks
setup_vim
setup_tmux
install_gems
make_local_configs
check_for_homebrew

echo "Consider running '~/dotfiles/configure-osx'"
echo "You should also run 'bundle install' when you've installed ruby"
echo "Remember to install tmux plugins with prefix + I"
