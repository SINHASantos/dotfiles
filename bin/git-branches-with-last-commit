#!/usr/bin/env ruby

require "active_support/core_ext/time/calculations"
require "action_view"
require "colorize"

class RailsViewStuff
  extend ActionView::Helpers::DateHelper
end

branches = `git branch`.lines.map do |line|
  line = line.chomp
  branch = line[2..-1]
  stats = `git show --stat #{branch}`.lines.map(&:chomp)
  time = stats.grep(/Date: /).first.split(" ", 2).last
  author = stats.grep(/Author: /).first.split(" ", 2).last.split(" ").first

  [branch, Time.parse(time), author]
end

lines = branches.sort_by(&:second).reverse.map do |branch, time, author|
  ago = RailsViewStuff.time_ago_in_words(time)

  ago = if ago.include?("month") || ago.include?("year")
          ago.red
        elsif ago.include?("day")
          ago.yellow
        else
          ago.blue
        end

  [branch, ago, author]
end

longest_branch = lines.map(&:first).sort_by(&:length).last.length
longest_time = lines.map(&:second).sort_by(&:length).last.length

lines.each do |branch, time, author|
  puts "#{branch.ljust(longest_branch)} | #{time.ljust(longest_time)} #{author}"
end
